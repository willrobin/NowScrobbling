# Cursor Rules for NowScrobbling

> See `CLAUDE.md` for full project documentation, architecture, and v1.4 roadmap.

## Quick Context

WordPress plugin for Last.fm + Trakt.tv activity display. SSR + AJAX hydration. Aggressive caching with graceful fallbacks.

**Core Philosophy**: "Old data is better than error messages"

## Directory Rules

| Path | Purpose | Rules |
|------|---------|-------|
| `nowscrobbling.php` | Bootstrap only | NO feature logic here |
| `includes/api-functions.php` | API + caching | All HTTP goes through helpers |
| `includes/shortcodes.php` | Shortcode defs | Must use `wrap_output()` pattern |
| `includes/admin-settings.php` | Admin UI | Capability checks required |
| `includes/ajax.php` | AJAX handlers | Nonce + whitelist validation |

## Naming Conventions

```
Functions:  nowscrobbling_*  (helpers)
            nowscr_*         (shortcodes only)
Options:    ns_*             (new options)
Text:       __('...', 'nowscrobbling')
```

## Mandatory Patterns

### Shortcode Output
```php
return nowscrobbling_wrap_output($slug, $html, $hash, $nowplaying);
```

### Caching (ALWAYS use helpers)
```php
// Correct
$data = nowscrobbling_get_or_set_transient($key, $callback, $ttl);
$response = nowscrobbling_fetch_api_data($url, $headers, $args, $cache_key);

// WRONG - never bypass caching
$response = wp_remote_get($url);
```

### Security
```php
// Input: sanitize AFTER unslash
$value = sanitize_text_field(wp_unslash($_POST['key']));

// Output: escape at render
echo esc_html($text);
echo esc_attr($attr);
echo esc_url($url);

// AJAX: verify nonce
wp_verify_nonce($nonce, 'nowscrobbling_nonce');

// Admin: check capability
if (!current_user_can('manage_options')) wp_die();
```

## Code Style

- Early returns, handle errors first
- Flat structure, avoid deep nesting
- Descriptive function names (no abbreviations)
- Sanitize at input, escape at output
- Log with `nowscrobbling_log()` for significant events

## Do / Don't

### DO
- Reuse existing helpers (`*_fetch_*`, `*_get_or_set_transient`, `*_wrap_output`)
- Keep bootstrap file minimal
- Add new shortcodes to whitelist AND shortcode list
- Test with debug logging enabled
- Follow existing patterns in the codebase

### DON'T
- Bypass caching or cooldowns
- Add frontend frameworks or heavy dependencies
- Echo output in bootstrap file
- Introduce new global state without need
- Refactor unrelated code in the same edit
- Commit credentials or API keys

## Testing Checklist

Before committing:
- [ ] Admin settings page loads
- [ ] API Test succeeds (or fails gracefully)
- [ ] Shortcodes render SSR + AJAX refresh
- [ ] Cache clear works
- [ ] No PHP notices in debug mode
- [ ] No fatal errors when credentials missing

## Version Bump

When releasing:
1. `nowscrobbling.php` header `Version:`
2. `NOWSCROBBLING_VERSION` constant
3. `README.md` version mention
4. `CHANGELOG.md` entry
